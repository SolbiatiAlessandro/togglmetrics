extends layout

block content
	.row.p-4
		.col-2
			.card.h-100
				.card-body
					h5.card-title togglmetrics
					h6.card-subtitle.mb-2.text-muted toggl sent #{length} Time Entries
					a.card-link.text-info(onclick='openDebug()') Debug
		.col-4
			.card.h-100
				.card-body
					form(id='updateForm' method='post', action='/', enctype='application/json')
						.form-group
							input#toggl-api-key.form-control(type='text' name='toggl-api-key' placeholder='Your toggl account API key' required='')
							small.form-text.text-muted Look for API Token at https://track.toggl.com/profile
						.form-group
							input#workspace-id.form-control(type='text' placeholder='Your workspace id' name='workspace-id' required='')
							small.form-text.text-muted Go at https://track.toggl.com/settings and copy the number from the url 
						button.btn.btn-primary(type='submit') Update Token

		.col-6
			.card.h-100
				.card-body.btn-group.flex-wrap
					each project in unique_projects
						.dropdown.p-2
							button.project.btn.btn-secondary.dropdown-toggle(type='button' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' id=project)
								| #{project}
							.dropdown-menu(aria-labelledby=project)
								each category, index in categories
									button.dropdown-item(onclick=`setProjectCategory('${project}', ${index});open_updateProjectsFooter();`) #{category}
				.card-footer(id="updateProjectsFooter", style="display:none")
					button.btn.btn-primary.card-link(onclick="updateProjects();") Update Projects

	.card.m-4
		canvas(style="width:60%;height:600px", id="canvas")

	div(id="debug" style="display:none;" )
		button(onclick='closeDebug()') hide debug informations
		p #{debug}
		p unique dates are #{unique_dates}

	script.
		// togglmetrics logic
		var projectCategoryMap = !{JSON.stringify(project_category)};
		var uniqueProjects = !{JSON.stringify(unique_projects)};
		var categoriesColor = !{JSON.stringify(categories_color)};

		var setProjectCategory = function(project, category){
			// category is 0, 1, 2

			// update UI
			document.getElementById(project).style.background = categoriesColor[category]
			document.getElementById(project).setAttribute("category", category)

			// set the value in the hidden input from updateForm
			document.getElementById(project + "__form").setAttribute("value", category)
		}

		var updateForm = $("#updateForm")[0];
		uniqueProjects.forEach(function(project){
			var category = projectCategoryMap[project];
			
			// add project field to update form
			const hiddenField = document.createElement('input');
			hiddenField.id = project + "__form";
			hiddenField.type = 'hidden';
			hiddenField.name = project;
			updateForm.appendChild(hiddenField);

			setProjectCategory(project, category);
		});

		var updateProjects = () => {updateForm.submit();}

	script.
		// page logic
		const displayElem = (val) => {return (id) => {document.getElementById(id).style.display = val;}};
		const showElem = (id) => {return () => {displayElem('block')(id)}};
		const hideElem = (id) => {return () => {displayElem('none')(id)}};

		const openDebug = showElem('debug');
		const closeDebug = hideElem('debug');
		const open_updateProjectsFooter = showElem('updateProjectsFooter');


	script.
		// Chart.js logic
		window.randomScalingFactor = function() {
			return 20
		};
		var barChartData = !{JSON.stringify(duration_bar_chart)};
		window.onload = function() {
			var ctx = document.getElementById('canvas').getContext('2d');
			window.myBar = new Chart(ctx, {
				type: 'bar',
				data: barChartData,
				options: {
					title: {
						display: false,
						text: 'Chart.js Bar Chart - Stacked'
					},
					tooltips: {
						mode: 'index',
						intersect: false
					},
					responsive: true,
					scales: {
						xAxes: [{
							stacked: true,
						}],
						yAxes: [{
							stacked: true
						}]
					}
				}
			});
		};

